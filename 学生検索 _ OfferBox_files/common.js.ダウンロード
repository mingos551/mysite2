$(document).ready(function() {

    $('.navigation-accordion--control').live('click' , function(e){
        e.preventDefault();
        // 現在のアイコン状態で＋にするか−にするか判定
        if($(this).children('i').is('.icon-chevron-up')){
            // ＋アイコンに変更
            $(this).children('i').removeClass().addClass('icon icon-chevron-down');
        }else{
            // −アイコンに変更
            $(this).children('i').removeClass().addClass('icon icon-chevron-up');
        }
        // クリックしたリストの開閉
        $(this).next('.navigation-accordion--panel').slideToggle(1);
    });

    // チュートリアルリセット
    $('.tutorial_reset').click(function(event) {
        $('.dropdown.open .dropdown-toggle').dropdown('toggle');
        if(window.confirm('チュートリアルをもう一度再生してよろしいですか？')) {
            $.ajax({
                url      : location.protocol + '//' + location.hostname + '/csettings/tutorial_reset',
                type     : 'POST',
                dataType : 'json'
            }).done(function(res) {
                try {
                    if (res === null) {
                        throw '代行企業の権限により機能制限がかかっています。';
                    }
                    alert('チュートリアルをリセットしました。');
                } catch {
                    alert('代行権限によりこの操作は禁止されています。');
                }

            });
        }
        return false;
    });


    // sidebar badge ignore page
    var url_split = location.pathname.split('/');

    // SidebarBadgeを実行しないページを指定
    var ignore = ['clogin', 'ctrial', 'ciperror'];
    var in_array = false;

    $.each(ignore, function(index, val) {
        if ($.inArray(val, url_split) >= 0) {
            in_array = true;
        }
    });

    // URLにignoreがない場合のみ実行する
    if (!in_array) {
        setSidebarBadge();
    }
});

/**
 * サイドバーバッジ表示
 */
function setSidebarBadge() {
    var sidebar_badge = $('<span />').addClass('ofb-badge ofb-badge--alert');
    $.ajax({
        url      : '/api/company/badge/sidebar_badge',
        type     : 'GET',
        dataType : 'json',
        cache    : false
    })
    .done(function(res) {
        if (res.favorite_reply > 0) {
            $('#sidebar-favorite').append(sidebar_badge.clone().html(res.favorite_reply));
        }
        if (res.offer_reply.all > 0) {
            // var reject_unread_cnt = 0;
            // $.each(res.offer_reply, function(index, val) {
            //     if (val.hasOwnProperty(110)) {
            //         reject_unread_cnt += val[110];
            //     }
            // });
            // var view_count = res.offer_reply.all - reject_unread_cnt;
            var view_count = res.offer_reply.all - res.offer_reply.reject_unread;
            if (view_count > 0) {
                $('#sidebar-offer').append(sidebar_badge.clone().html(view_count));
            }
        }
        if (res.look_reply > 0) {
            $('#sidebar-look-at-me').append(sidebar_badge.clone().html(res.look_reply));
        }
        // TODO: ページ内との整合性を取る
        // if (res.interview_reply.cnt > 0) {
        //     $('#sidebar-interview').append(sidebar_badge.clone().html(res.interview_reply.cnt));
        // }
        if (res.event.all > 0) {
            $('#sidebar-event-list').append(sidebar_badge.clone().html(res.event.all));
        }
        if (res.companychat.cnt > 0) {
            $('#sidebar-companychat').append(sidebar_badge.clone().html(res.companychat.cnt));
        }
        if (res.decidechat.cnt + res.decide_approved_report.cnt > 0) {
            $('#sidebar-decidechat').append(sidebar_badge.clone().html(res.decidechat.cnt + res.decide_approved_report.cnt));
        }
    });
}

function loadingStart() {
    $('.loading').remove();
    $('body').append('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></div>');
}

function loadingStop() {
    $('.loading').remove();
}
