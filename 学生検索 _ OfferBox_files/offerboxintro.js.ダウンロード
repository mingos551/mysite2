(function($){

    // 表示場所と表示文
    var intro_set = {
        '/cstudent' : {
            'stage' : 'before_search',
            'steps' : [
                {
                    element  : '#search-form',
                    position : 'right',
                    intro    : 'さまざまなタイプの学生がOfferBoxに登録しています。<br>大学名、留学経験、部活動など細かい検索が可能です。<br>「企画」「リーダー」など「主体性」から浮かび上がる具体的な行動をキーワード指定することで、主体的な経験のある学生を探すことが可能です。'
                },
                {
                    element  : '#default-result .ofb-btn--favorite',
                    position : 'top',
                    intro    : '貴社に合う学生を見つけるために「検討する」ボタンを有効的に使い、絞り込んでいきます。<br>貴社にマッチしそうな学生は検討中リストに追加しましょう。'
                },
                {
                    element  : '#default-result .studentToHide',
                    position : 'bottom',
                    intro    : '貴社にマッチしない学生は「この学生を非表示」ボタンを有効的に使い、絞り込んでいきます。<br>クリックすると次回からの検索結果から除外されます。<br>「設定」→「<a href="//' + location.host + '/v2/cstudenthide">非表示リスト</a>」から復活させる事も可能です。'
                },
                {
                    element  : '.c-fixed__save',
                    position : 'top',
                    intro    : '検索した条件を「検索条件リスト」に保存する事ができます。<br>以後ワンクリックで、その条件に合致した学生リストを表示する事ができます。<br>検索条件リストは、サービス毎に最大10件まで保存できます。'
                },
                {
                    element  : '.student-control--search',
                    position : 'bottom',
                    intro    : '検索結果を並び替えることができます。'
                },
                {
                    element  : '.intro__listchange',
                    position : 'bottom',
                    intro    : '学生の表示をリスト形式、パネル形式で切り替えることができます。'
                }
            ]
        },
        '/cstudent/prof' : {
            'stage' : 'before_write_more',
            'steps' : [
                {
                    element  : '.ofb-btn__more',
                    position : 'top',
                    intro    : '検討中もしくはオファーをするための情報がもっとほしい場合に、学生に対して匿名でリクエストを送ることができます。<br>ただし、1日に送信できる学生へのリクエストは100件までです。'
                },
                {
                    element  : '#modal-writemore',
                    position : 'right',
                    intro    : 'プロフィールについて充実をお願いしたい項目をチェックし、送信して下さい。（複数選択可）'
                },
                {
                    element  : '.js-label-control',
                    position : 'bottom',
                    intro    : 'リクエストを送った学生には「もっと書いて送信済」ラベルが追加されるので、学生の管理に便利です。'
                }
            ]
        }
    }

    var url_path = getUrlPath();

    /**
     * URLから判断してイントロ表示呼び出し
     * @return {[type]} [description]
     */
    $.fn.offerboxIntro = function() {
        return this.each(function() {
            if (intro_set[url_path]) {
                var steps = intro_set[url_path].steps;

                if (url_path == '/cstudent/prof') {
                    $('html, body').animate({scrollTop: 500});
                    $('body').css('overflow-y', 'hidden');
                }

                if (url_path == '/cstudent' || url_path == '/cstudent/prof') {
                    if (url_path == '/cstudent/prof') {
                        $('body').addClass('introjs-fixed-obj');
                    }
                    // 学生検索が非同期で表示されるため表示されるまでのチェック
                    var dom_check = setInterval(function(){
                        if ($('.ofb-btn--favorite')[0] || $('.js-label-control')[0]) {
                            show_intro(steps);
                            clearInterval(dom_check);
                        }
                    }, 500);
                } else {
                    show_intro(steps);
                }
            }
        });
    };

    /**
     * イントロJS表示
     * 各DOMが存在しないと表示されない
     * @param  {[type]} steps [steps in intro_set]
     * @return {[type]}       [description]
     */
    function show_intro(steps) {
        var show_flg = true;
        for (var i = 0; i < steps.length; i++) {
            if ($(steps[i].element).length == 0) {
                console.log(steps[i].element);
                show_flg = false;
                break;
            }
        }
        if (show_flg) {

            var intro = introJs();
            intro.setOptions({
                steps           : steps,
                nextLabel       : '次へ',
                prevLabel       : '戻る',
                skipLabel       : 'スキップ',
                doneLabel       : '閉じる',
                overlayOpacity  : 0.5,
                showStepNumbers : false,
            });
            intro.start();

            intro.onbeforechange(function(targetElement) {
                if (intro_set[url_path].stage == 'before_search') {
                    if ($(targetElement).hasClass('c-fixed__save')) {
                        $('body').addClass('introjs-fixed-obj');
                    } else {
                        $('body').removeClass('introjs-fixed-obj');
                        $('.introjs-tooltipReferenceLayer.introjs-fixedTooltip').removeClass('introjs-fixedTooltip');
                    }
                }

                writeMoreIntroTrigger(targetElement, 'onbeforechange');

            }).onchange(function(targetElement) {

            }).onafterchange(function(targetElement) {
                writeMoreIntroTrigger(targetElement, 'onafterchange');

            }).onexit(function(targetElement) {
                writeMoreIntroTrigger(targetElement, 'onexit');

            }).oncomplete(function(targetElement) {
                $('body').removeClass('introjs-fixed-obj');

                writeMoreIntroTrigger(targetElement, 'oncomplete');
            });
        }
    }

    function writeMoreIntroTrigger(targetElement, trigger) {
        if (intro_set[url_path].stage == 'before_write_more') {
            if (trigger == 'onbeforechange') {
                // もっと書いてボタンのステップ時
                if ($(targetElement).hasClass('ofb-btn__more')) {
                    $('body').addClass('introjs-fixed-obj');
                } else {
                    $('body').removeClass('introjs-fixed-obj');
                }

                // もっと書いてモーダルのステップ時
                if ($(targetElement).attr('id') == 'modal-writemore') {
                    $('#modal-writemore').modal('show').addClass('pos-f');
                } else {
                    $('#modal-writemore').modal('hide').removeClass('pos-f');
                }

            } else if (trigger == 'onafterchange') {
                // もっと書いてモーダルのステップ時
                if ($(targetElement).attr('id') == 'modal-writemore') {
                    $('.introjs-fixedTooltip').addClass('pos-f');
                } else {
                    $('.introjs-fixedTooltip').removeClass('pos-f');
                }

                // ラベル追加のステップ時、positionをfixからabsoluteに
                if ($(targetElement).hasClass('js-label-control')) {
                    $('.introjs-fixedTooltip').css('position', 'absolute');
                }

            } else if (trigger == 'onexit') {
                // 「もっと書いて」ボタンのステップ時に「スキップ」ボタンを押下されると、
                // introjs-fixed-objが削除されないままなのでオファーのサイドバーが隠れてしまうのを防ぐ
                if ($('body').hasClass('introjs-fixed-obj')) {
                    $('body').removeClass('introjs-fixed-obj');
                }
                $('body').css('overflow-y', '');

            } else if (trigger == 'oncomplete') {
                $('body').css('overflow-y', '');
            }

        }
    }

    function getUrlPath() {
        var url_path = location.pathname.replace(/\/index.php/, '') + location.hash;

        if (url_path.match(/\/[0-9]+\/?/)) {
            return url_path.replace(/\/[0-9]+\/?/, '');
        }

        return url_path;
    }

    $(document).ready(function() {
        $auth = $('.brand-name').attr('data-auth');
        if (!$auth) {
            // URLとチュートリアル進行度をチェックしてチュートリアル開始
            if (intro_set[url_path]) {
                var root_url = location.protocol + '//' + location.hostname;
                $.ajax({
                    url      : root_url + '/csettings/tutorial_check',
                    type     : 'POST',
                    dataType : 'json',
                    data     : {
                        'stage': intro_set[url_path].stage
                    }
                })
                .done(function(res) {
                    if (!res.end) {
                        $(document).offerboxIntro();
                    }
                });
            }
        }
    });
})(jQuery);
