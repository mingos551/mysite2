$(function () {
    var offerbox_modal_tutorial = {
        before_first_offer: {
            title: 'はじめてのオファーを送る前に',
            content: '<p>オファーを送る前に初期設定をしておくと、２回目以降のオファー送信の時間を大幅に減らすことができます。<a href="/v2/csettings/offer">オファー初期設定</a>で必要な情報を入力していきましょう。</p><div class="mt20"></div><div class="centered mb20"><a href="/v2/csettings/offer" class="ofb-btn ofb-btn--large ofb-btn--general">オファー初期設定へ</a></div><div class="pull-right"><a href="#" id="offer_click_skip">スキップ</a></div>'
        },
        before_first_favorite: {
            title: '検討中リストに入れる前に',
            content: '<p>検討中に入れると学生に貴社の情報が開示されます。「会いたい通知」がくるように、 <a href="/v2/csettings/company">企業基本情報入力</a>で未入力部分を入力していきましょう。</p><div class="mt20"></div><div class="centered mb20"><a href="/v2/csettings/company" class="ofb-btn ofb-btn--large ofb-btn--general">企業基本情報入力へ</a></div><div class="pull-right"><a href="#" id="skip_before_first_favorite">スキップ</a></div>'
        },
        after_first_favorite: {
            title: '検討中リストに追加されました',
            content: '<p>検討中に追加した学生はサイドメニューの <a href="/cfavorite/list">検討中リスト</a>で確認できます。学生が貴社に興味があれば、会いたい通知が送られてきます。</p><div class="mt20"></div><div class="centered mb20"><a href="/cfavorite/list" class="ofb-btn ofb-btn--large ofb-btn--general">検討中リストへ</a></div><div class="pull-right"><a href="#" data-dismiss="modal">閉じる</a></div>'
        }
    };

    /**
     * モーダルの作成表示 id="tutorial_modal"
     * @param  {[type]} stage [offerbox_modal_tutorialのkey]
     * @return {[type]}       [description]
     */
    function modal_view(stage) {
        if (stage in offerbox_modal_tutorial) {
            var title = offerbox_modal_tutorial[stage].title;
            var content = offerbox_modal_tutorial[stage].content;
            var modal = $('<div id="tutorial_modal"></div>').addClass('modal hide').attr('data-backdrop', 'static');
            modal.append($('<div></div>').addClass('modal-header').html($('<h2></h2>').addClass('centered').text(title)));
            modal.append($('<div></div>').addClass('modal-body').html(content));
            $('body').append(modal);
            modal.modal('show');
        }
    }

    /**
     * 各チュートリアル進行度チェック
     * @param  {[type]} stage [offerbox_modal_tutorialのkey]
     * @return ajax
     */
    function send_check(stage) {
		var root_url = location.protocol + '//' + location.hostname;
        return $.ajax({
            url      : root_url + '/csettings/tutorial_check',
            type     : 'POST',
            dataType : 'json',
            async    : false,
            data     : { 'stage': stage }
        });
    }

    // before first offer
    var offer_click_terget = null;
    $('.ofb-btn--offer:not(.disabled)').live('click', function(event) {
        var stage = 'before_first_offer';
        var flg = true;

        if (offer_click_terget == null) {
            offer_click_terget = $(this).find('i');
            send_check(stage).done(function(res) {
                if (!res.end) {
                    modal_view(stage);
                    flg = false;
                }
            });
        }

        return flg;
    });

    // offer modal skip
    $('#offer_click_skip').live('click', function(event) {
        offer_click_terget.click();
        $('#tutorial_modal').modal('hide');
        return false;
    });

    // before first favorite
    var favorite_click_target = null;
    var after_first_favorite_modal_flag = true;
    $('.ofb-btn--favorite:not(.disabled)').live('click', function(event) {
        
        // デモアカウントの場合、検討不可
        if($(':hidden[name="demo_account"]').val()){
            alert("デモアカウントのため、検討中リストに保存できません。")
            return;
        }

        // has link is not working
        if ($(this).attr('href')) {
            return true;
        }

        var add_favorite = false;

        if (favorite_click_target == null) {
            favorite_click_target = $(this);
            // first click favorite modal
            send_check('before_first_favorite').done(function(res) {
                if (res.end) {
                    favorite_click_target.favorite_save();
                    add_favorite = true;
                } else {
                    modal_view('before_first_favorite');
                }
            });
        } else {
            $(this).favorite_save();
            add_favorite = true;
        }

        // first add favorite modal
        if (add_favorite && after_first_favorite_modal_flag) {
            send_check('after_first_favorite').done(function(res) {
                if (!res.end) {
                    modal_view('after_first_favorite');
                }
            });
            after_first_favorite_modal_flag = false;
        }

    });

    // before favorite modal skip
    $('#skip_before_first_favorite').live('click', function(event) {
        favorite_click_target.favorite_save();
        send_check('after_first_favorite').done(function(res) {
            if (!res.end) {
                $('#tutorial_modal').find('h2').text(offerbox_modal_tutorial.after_first_favorite.title);
                $('#tutorial_modal').find('.modal-body').html(offerbox_modal_tutorial.after_first_favorite.content);
            } else {
                $('#tutorial_modal').modal('hide');
            }
        });
        after_first_favorite_modal_flag = false;
        return false;
    });

})
