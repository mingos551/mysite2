/**
 * @param string
 */
const ConsistentLoginApi = function(idStr){
    this.idStr = idStr;
    this.failCount = 0;
    this.defualtRedirectPath = '/v2/clogin/logout';
}

ConsistentLoginApi.prototype.check = function() {
    const element = document.getElementById(this.idStr);
    let thisState = this;
    if (element != null) {
        let settings = {
            url      : '/api/company/auth/consistentlogin/check',
            type     : 'POST',
            dataType : 'json',
            cache    : false,
            data     : {
                token_consistent_login: element.dataset.token
            }
        };

        const userAgentStr = window.navigator.userAgent
        if (userAgentStr.toLowerCase().indexOf('chrome') == -1
            && userAgentStr.toLowerCase().indexOf('safari') != -1
        ) {
            settings.async = false;
        }

        $.ajax(settings)
        .done(function(response) {
            if (!response.isConsistent) {
                window.location.href = response.redirectPath;
            }
        })
        .fail(function() {
            if (thisState.failCount == 0) {
                alert('通信に失敗しました。しばらく経ってから再度お試しいただくか、インターネット環境をご確認ください。');
            }
            if (thisState.failCount == 1) {
                alert("ログイン情報を取得できませんでした。\n再度ログインしてください。");
                window.location.href = thisState.defualtRedirectPath;
            }
            thisState.failCount+=1;
        });
    }
}
